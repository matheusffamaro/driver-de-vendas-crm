name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        env:
          APP_KEY: ${{ secrets.APP_KEY }}
          APP_URL: ${{ secrets.APP_URL }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          MAIL_HOST: ${{ secrets.MAIL_HOST }}
          MAIL_PORT: ${{ secrets.MAIL_PORT }}
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
          MAIL_ENCRYPTION: ${{ secrets.MAIL_ENCRYPTION }}
          MAIL_FROM_ADDRESS: ${{ secrets.MAIL_FROM_ADDRESS }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          MICROSOFT_CLIENT_ID: ${{ secrets.MICROSOFT_CLIENT_ID }}
          MICROSOFT_CLIENT_SECRET: ${{ secrets.MICROSOFT_CLIENT_SECRET }}
          PAYPAL_CLIENT_ID: ${{ secrets.PAYPAL_CLIENT_ID }}
          PAYPAL_CLIENT_SECRET: ${{ secrets.PAYPAL_CLIENT_SECRET }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          command_timeout: 30m
          envs: APP_KEY,APP_URL,FRONTEND_URL,DB_PASSWORD,JWT_SECRET,REDIS_PASSWORD,GROQ_API_KEY,GEMINI_API_KEY,MAIL_HOST,MAIL_PORT,MAIL_USERNAME,MAIL_PASSWORD,MAIL_ENCRYPTION,MAIL_FROM_ADDRESS,GOOGLE_CLIENT_ID,GOOGLE_CLIENT_SECRET,MICROSOFT_CLIENT_ID,MICROSOFT_CLIENT_SECRET,PAYPAL_CLIENT_ID,PAYPAL_CLIENT_SECRET
          script: |
            set -e
            
            PROJECT_DIR="/opt/driver-crm"
            DOCKER_DIR="${PROJECT_DIR}/docker"
            ENV_FILE="${DOCKER_DIR}/.env.prod"
            
            echo "══════ Pull latest code ══════"
            cd "${PROJECT_DIR}"
            git fetch origin main
            git reset --hard origin/main
            
            echo "══════ Write .env.prod from GitHub Secrets ══════"
            cat > "${ENV_FILE}" <<ENVEOF
            # Auto-generated by GitHub Actions deploy — $(date -u +"%Y-%m-%dT%H:%M:%SZ")
            APP_KEY=${APP_KEY}
            APP_URL=${APP_URL}
            FRONTEND_URL=${FRONTEND_URL}

            DB_DATABASE=crm_whitelabel
            DB_USERNAME=postgres
            DB_PASSWORD=${DB_PASSWORD}

            JWT_SECRET=${JWT_SECRET}
            REDIS_PASSWORD=${REDIS_PASSWORD}

            AI_PROVIDER=groq
            GROQ_API_KEY=${GROQ_API_KEY}
            GROQ_MODEL=llama-3.3-70b-versatile
            GEMINI_API_KEY=${GEMINI_API_KEY}
            GEMINI_MODEL=gemini-2.0-flash

            MAIL_MAILER=smtp
            MAIL_HOST=${MAIL_HOST}
            MAIL_PORT=${MAIL_PORT}
            MAIL_USERNAME=${MAIL_USERNAME}
            MAIL_PASSWORD=${MAIL_PASSWORD}
            MAIL_ENCRYPTION=${MAIL_ENCRYPTION}
            MAIL_FROM_ADDRESS=${MAIL_FROM_ADDRESS}
            MAIL_FROM_NAME="Driver de Vendas CRM"

            GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
            GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
            MICROSOFT_CLIENT_ID=${MICROSOFT_CLIENT_ID}
            MICROSOFT_CLIENT_SECRET=${MICROSOFT_CLIENT_SECRET}

            PAYPAL_MODE=live
            PAYPAL_CLIENT_ID=${PAYPAL_CLIENT_ID}
            PAYPAL_CLIENT_SECRET=${PAYPAL_CLIENT_SECRET}
            ENVEOF
            # Remove leading whitespace from heredoc
            sed -i 's/^            //' "${ENV_FILE}"
            chmod 600 "${ENV_FILE}"
            echo ".env.prod written ($(wc -l < "${ENV_FILE}") lines)"
            
            echo "══════ Rebuild & restart containers ══════"
            cd "${DOCKER_DIR}"
            docker compose -f docker-compose.prod.yml --env-file "${ENV_FILE}" pull 2>/dev/null || true
            docker compose -f docker-compose.prod.yml --env-file "${ENV_FILE}" up -d --build --remove-orphans
            
            echo "══════ Wait for services ══════"
            sleep 10
            
            echo "══════ Run migrations ══════"
            docker exec dv-api php artisan migrate --force
            
            echo "══════ Clear & rebuild caches ══════"
            docker exec dv-api php artisan config:cache
            docker exec dv-api php artisan route:cache
            docker exec dv-api php artisan view:cache
            
            echo "══════ Setup scheduler cron ══════"
            (crontab -l 2>/dev/null | grep -v "artisan schedule:run") | crontab -
            (crontab -l 2>/dev/null; echo "* * * * * docker exec dv-api php /var/www/html/artisan schedule:run >> /var/log/laravel-scheduler.log 2>&1") | crontab -
            echo "Cron configured"
            
            echo "══════ Health check ══════"
            for i in $(seq 1 10); do
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:3000 || echo "000")
              if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ]; then
                echo "Frontend OK (HTTP ${HTTP_CODE})"
                break
              fi
              echo "Waiting for frontend... (attempt ${i}/10, HTTP ${HTTP_CODE})"
              sleep 5
            done
            
            API_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8000/api/plans || echo "000")
            echo "API status: HTTP ${API_CODE}"
            
            echo "══════ Container status ══════"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            echo "══════ Deploy complete ══════"
